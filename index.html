<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aurum Ultimate • Hostel Finance</title>
  <meta name="description" content="The #1 expense tracker for Bangladeshi students — cloud sync, AI roast, viral sharing" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="light">

  <!-- Login Screen -->
  <div id="authScreen" class="screen active">
    <div class="glass auth-box">
      <h1>Aurum</h1>
      <p>Premium • Cloud Sync • Made for Hostels</p>
      <input type="email" id="email" placeholder="you@example.com" required />
      <input type="password" id="password" placeholder="Password" required />
      <button class="gold-btn" onclick="signup()">Create Account</button>
      <button class="outline-btn" onclick="login()">Log In</button>
      <p id="authError" style="color:#ff6b6b;margin-top:10px;min-height:20px;"></p>
    </div>
  </div>

  <!-- Main App -->
  <div id="appScreen" class="screen">
    <header class="topbar">
      <h1>Aurum</h1>
      <div class="header-actions">
        <small id="userDisplay"></small>
        <button id="themeToggle"><i class="fas fa-moon"></i></button>
        <button id="currencyBtn">৳ BDT</button>
        <button onclick="showPage('history')"><i class="fas fa-history"></i></button>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Dashboard -->
    <main id="dashboard" class="page active">
      <div class="balance-card glass">
        <p>Total Spent</p>
        <h1 id="totalSpent">৳ 0</h1>
        <div class="gold-line"></div>
      </div>

      <div class="stats-grid">
        <div class="glass stat"><strong id="expenseCount">0</strong><br>Expenses</div>
        <div class="glass stat"><strong id="nextMonthAI">...</strong><br>Next Month</div>
        <div class="glass stat"><strong id="streakCount">0 Day</strong><br>Streak</div>
      </div>

      <!-- Viral Share Card -->
      <div id="shareCard" class="share-card glass">
        <h3>This Month's Summary</h3>
        <p><strong id="cardAmount">৳ 0</strong> spent</p>
        <p>Top Category: <strong id="topCategory">Food</strong></p>
        <p>You are a <strong id="personalityLabel">Smart Saver</strong></p>
        <button class="share-btn" onclick="shareSummary()">Share on Instagram</button>
      </div>

      <!-- AI Roast -->
      <div class="roast-card glass">
        <p id="roastText">Add expenses to get roasted</p>
        <button class="share-btn" onclick="shareRoast()">Share Roast</button>
      </div>

      <button class="fab" onclick="openAddModal()">+</button>
    </main>

    <!-- Full History -->
    <div id="history" class="page">
      <div class="topbar">
        <button onclick="showPage('dashboard')">Back</button>
        <h2>Full History</h2>
      </div>
      <input type="text" id="searchInput" placeholder="Search expenses..." oninput="filterHistory()" />
      <div id="historyList" class="history-list"></div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addModal" class="modal">
      <div class="glass form">
        <h3>Add Expense</h3>
        <input type="text" id="desc" placeholder="Description (e.g. Biriyani)" />
        <input type="text" id="cat" placeholder="Category" list="categories" />
        <datalist id="categories">
          <option>Food</option><option>Transport</option><option>Mess Bill</option>
          <option>Recharge</option><option>Shopping</option><option>Snacks</option>
          <option>Hall Fee</option><option>Coaching</option><option>Fuchka</option>
        </datalist>
        <input type="number" id="amt" placeholder="Amount" step="1" />
        <button class="gold-btn" onclick="saveExpense()">Save</button>
        <button onclick="closeAddModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Full Firebase + All Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX4W9VMWulR_SkawcPsSs0eTC7igH09ms",
      authDomain: "aurum-cloud.firebaseapp.com",
      projectId: "aurum-cloud",
      storageBucket: "aurum-cloud.firebasestorage.app",
      messagingSenderId: "999926729828",
      appId: "1:999926729828:web:636c14afe371f2b526e371"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    let expenses = [];
    let currency = "BDT";
    let symbol = "৳";
    const rates = { BDT: 1, INR: 0.73, USD: 0.0085, EUR: 0.0078, GBP: 0.0072 };
    const symbols = { BDT: "৳", INR: "₹", USD: "$", EUR: "€", GBP: "£" };

    // Auth State
    onAuthStateChanged(auth, (u) => {
      if (u) {
        user = u;
        document.getElementById("userDisplay").textContent = u.email.split("@")[0];
        document.getElementById("authScreen").classList.remove("active");
        document.getElementById("appScreen").classList.add("active");
        loadExpenses();
      } else {
        document.getElementById("authScreen").classList.add("active");
        document.getElementById("appScreen").classList.remove("active");
      }
    });

    window.login = () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, pass)
        .catch(err => document.getElementById("authError").textContent = err.message);
    };

    window.signup = () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      createUserWithEmailAndPassword(auth, email, pass)
        .catch(err => document.getElementById("authError").textContent = err.message);
    };

    window.logout = () => signOut(auth);

    function loadExpenses() {
      const q = query(collection(db, "users", user.uid, "expenses"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateAllUI();
      });
    }

    window.saveExpense = async () => {
      const desc = document.getElementById("desc").value.trim() || "Expense";
      const cat = document.getElementById("cat").value.trim() || "Other";
      const amt = parseFloat(document.getElementById("amt").value);
      if (!amt || amt <= 0) return alert("Enter valid amount");

      await addDoc(collection(db, "users", user.uid, "expenses"), {
        desc, cat, amt, timestamp: new Date()
      });

      document.getElementById("desc").value = "";
      document.getElementById("cat").value = "";
      document.getElementById("amt").value = "";
      closeAddModal();
    };

    function updateAllUI() {
      const total = expenses.reduce((s, e) => s + e.amt, 0);
      const converted = (total * rates[currency]).toFixed(0);

      document.getElementById("totalSpent").textContent = `${symbol} ${Number(converted).toLocaleString()}`;
      document.getElementById("expenseCount").textContent = expenses.length;
      document.getElementById("cardAmount").textContent = `${symbol} ${Number(converted).toLocaleString()}`;

      const catSum = expenses.reduce((a, e) => (a[e.cat] = (a[e.cat] || 0) + e.amt, a), {});
      const topCat = Object.keys(catSum).sort((a, b) => catSum[b] - catSum[a])[0] || "None";
      document.getElementById("topCategory").textContent = topCat;

      const personalities = {
        Food: "Mess Food Lover", Snacks: "Fuchka Champion", Transport: "Ride-Share Addict",
        Recharge: "Data King", Shopping: "Daraz Addict", "Mess Bill": "Hostel Pro"
      };
      document.getElementById("personalityLabel").textContent = personalities[topCat] || "Smart Saver";

      const predicted = Math.round(total * 1.15 * rates[currency]);
      document.getElementById("nextMonthAI").textContent = `${symbol} ${predicted.toLocaleString()}`;

      const roast = topCat === "Snacks" && catSum.Snacks > 1200
        ? `Bro… ৳${catSum.Snacks} on fuchka & jhalmuri? Chill!`
        : topCat === "Food" && catSum.Food > 6000
          ? `Biriyani count: Dangerous levels detected`
          : "You're doing great! Keep it up!";
      document.getElementById("roastText").textContent = roast;

      const dates = [...new Set(expenses.map(e => new Date(e.timestamp.seconds * 1000).toISOString().slice(0,10)))].sort().reverse();
      let streak = 0;
      for (let i = 0; i < 30; i++) {
        const d = new Date(Date.now() - i * 86400000).toISOString().slice(0,10);
        if (dates.includes(d)) streak++;
        else if (i > 0) break;
      }
      document.getElementById("streakCount").textContent = `${streak} Day Streak`;

      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      expenses.forEach(e => {
        const date = new Date(e.timestamp.seconds * 1000).toLocaleDateString();
        const div = document.createElement("div");
        div.className = "glass history-item";
        div.innerHTML = `
          <div>
            <strong>${e.desc}</strong><br>
            <small>${e.cat} • ${date}</small>
          </div>
          <div style="text-align:right">
            <strong>${symbol} ${(e.amt * rates[currency]).toFixed(0)}</strong><br>
            <button class="delete-btn" onclick="deleteExpense('${e.id}')">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.deleteExpense = async (id) => {
      if (confirm("Delete this expense?")) {
        await deleteDoc(doc(db, "users", user.uid, "expenses", id));
      }
    };

    window.shareSummary = () => {
      html2canvas(document.getElementById("shareCard")).then(canvas => {
        canvas.toBlob(blob => {
          const file = new File([blob], "aurum-summary.png", { type: "image/png" });
          if (navigator.share && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: "My Aurum Summary" });
          } else {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "aurum-summary.png";
            a.click();
          }
        });
      });
    };

    window.shareRoast = () => {
      const text = document.getElementById("roastText").textContent;
      if (navigator.share) {
        navigator.share({ text: `Aurum Roast: ${text}\nDownload: https://aurum-ultimate.vercel.app` });
      }
    };

    document.getElementById("currencyBtn").onclick = () => {
      const input = prompt("Currency: BDT, INR, USD, EUR, GBP", currency);
      const code = input?.toUpperCase();
      if (rates[code]) {
        currency = code;
        symbol = symbols[code];
        document.getElementById("currencyBtn").textContent = `${symbol} ${currency}`;
        updateAllUI();
      }
    };

    window.openAddModal = () => document.getElementById("addModal").classList.add("active");
    window.closeAddModal = () => document.getElementById("addModal").classList.remove("active");
    window.showPage = (id) => {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
    window.toggleTheme = () => document.body.classList.toggle("dark") || document.body.classList.toggle("light");
    window.filterHistory = () => { /* Add search logic if needed */ };
  </script>
</body>
</html>
